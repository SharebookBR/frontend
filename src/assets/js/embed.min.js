var Application = Application || function(w, u){
    var wallObject = {

        },
        iframeModalObject = null,
        iframeModalLoaded = false,
        AppPath = "https://7499608.com/app/";
    /* AppPath = "https://localhost/workingcopy/trunk/app/"; */
    var receiveMessage = function(event) {
        var dataObject;
        if(typeof event.data == 'string')
        {
            dataObject = JSON.parse(event.data);
        }
        else
        {
            dataObject = event.data;
        }
        switch(dataObject.type){
            case 'getHeight':
                for(var i in wallObject)
                {
                    wallObject[i].style.height = dataObject.data.height+'px';
                }
                break;
            case 'showPopUp':
                dataObject.data.parentWidth = window.innerWidth;
                newIframe(dataObject.data);
                break;
            case 'closePopUp':
                closePopUp();
                break;
            default:
                break;
        }
    }
    var newIframe = function(data) {
        var elementExists = document.getElementById("_taggbox_modal_frame");
        if(elementExists && iframeModalObject)
        {
            if(iframeModalLoaded)
            {
                elementExists.style.display = 'block';
                elementExists.contentWindow.postMessage(data,elementExists.src);
            }
            else
            {
                newIframe(data);
                return;
            }
        }
        else
        {
            iframeModalObject = document.createElement('iframe');
            iframeModalObject.src = AppPath+'w/endPoint/';
            iframeModalObject.id = '_taggbox_modal_frame';
            iframeModalObject.scrolling = 'no';
            iframeModalObject.frameborder = 0;
            iframeModalObject.allowtransparency = 'true';
            iframeModalObject.style.display = 'block';
            iframeModalObject.style.position = 'fixed';
            iframeModalObject.style.left = '0px';
            iframeModalObject.style.right = '0px';
            iframeModalObject.style.top = '0px';
            iframeModalObject.style.bottom = '0px';
            iframeModalObject.style.width = '100%';
            iframeModalObject.style.height = '100%';
            iframeModalObject.style.border = 'none';
            iframeModalObject.style.zIndex = '99999999';
            document.body.appendChild(iframeModalObject);
            iframeModalObject.onload = function() {
                iframeModalObject.contentWindow.postMessage(data,iframeModalObject.src);
            };

        }
    }
    var newModalIframe = function() {
        var elementExists = document.getElementById("_taggbox_modal_frame");
        if(!elementExists)
        {
            iframeModalObject = document.createElement('iframe');
            iframeModalObject.src = AppPath+'w/endPoint/';
            iframeModalObject.id = '_taggbox_modal_frame';
            iframeModalObject.scrolling = 'no';
            iframeModalObject.frameborder = 0;
            iframeModalObject.allowtransparency = 'true';
            iframeModalObject.style.display = 'none';
            iframeModalObject.style.position = 'fixed';
            iframeModalObject.style.left = '0px';
            iframeModalObject.style.right = '0px';
            iframeModalObject.style.top = '0px';
            iframeModalObject.style.bottom = '0px';
            iframeModalObject.style.width = '100%';
            iframeModalObject.style.height = '100%';
            iframeModalObject.style.border = 'none';
            iframeModalObject.style.zIndex = '99999999';
            document.body.appendChild(iframeModalObject);
            iframeModalObject.onload = function() {
                iframeModalLoaded = true;
            };
        }
    }
    var closePopUp = function() {
        document.getElementById("_taggbox_modal_frame").style.display = 'none';
    }
    return{
        init: function (){

            var count = 0;
            for(var prop in wallObject) {
                if(wallObject.hasOwnProperty(prop))
                    ++count;
            }
            if(count == 0)
            {
                window.addEventListener("message", receiveMessage, false);
            }
            //var container = document.querySelector('.taggbox-socialwall');
            var parentContainer = document.getElementsByClassName('taggbox-container');
            parentContainer[0].style.lineHeight = 'initial';
            var styleElement = document.createElement("style");
            styleElement.appendChild(document.createTextNode(".taggbox-container::-webkit-scrollbar {-webkit-appearance: none;width: 3px;} .taggbox-container::-webkit-scrollbar-thumb {border-radius: 4px;background-color: rgba(0,0,0,.5); .taggbox-container::-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);}"));
            styleElement.appendChild(document.createTextNode(".taggbox-container::-webkit-scrollbar {-webkit-appearance: none;width: 3px;} .taggbox-container::-webkit-scrollbar-thumb {border-radius: 4px;background-color: rgba(0,0,0,.5);-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);} .taggbox-container::-webkit-scrollbar-track{ box-shadow: inset 0 0 6px rgba(0,0,0,0.3);-moz-box-shadow:inset 0 0 6px rgba(0,0,0,0.3);-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);background-color: #f9f9f9;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;}"));
            parentContainer[0].appendChild(styleElement);
            var container = document.getElementsByClassName('taggbox-socialwall');

            var iframe;
            for(var i = 0;i < container.length;i++)
            {
                iframe = container[i].getElementsByTagName("iframe");
                if(iframe.length == 0)
                {

                    var wallUrl = container[i].getAttribute("data-wall-id");
                    var wallType = container[i].getAttribute("data-wall-type") || 'embed';
                    var frameUrl = '?webembed=1';
                    if(wallType == 'displayEmbed')
                    {
                        frameUrl = frameUrl+'&displayEmbed=1';
                    }
                    var iframeElem = '<iframe src="'+AppPath+'w/'+wallUrl+frameUrl+'" style="visibility: hidden;position: absolute;left: -999em;display: inline-block;border: none;width:100%;height:100%;" scrolling="no" frameborder="0" allowtransparency="true"></iframe><img id="_taggbox_modal_frame_loader" style="width: 30px;position: absolute;left: 50%;" src="'+AppPath+'image/loader.svg" />';
                    container[i].innerHTML = iframeElem;
                    container[i].style.webkitOverflowScrolling = "touch";
                    try{
                        /*console.log(container[i].parentElement);*/
                        container[i].parentElement.style.webkitOverflowScrolling = "touch";
                    } catch (err) {
                        console.log('a');
                    }
                    iframeElem = container[i].firstChild;
                    wallObject[i] = iframeElem;
                    iframeElem.onload = function() {
                        /*iframeElem.style.display = 'block';*/
                        iframeElem.style.visibility = 'visible';
                        iframeElem.style.position = 'static';
                        var parentContainerHeight = parentContainer[0].offsetHeight;
                        iframeElem.style.minHeight = parentContainerHeight+'px';
                        document.getElementById('_taggbox_modal_frame_loader').style.display = 'none';
                        var myurl = window.location.href;
                        var obj = {
                            type: 'startEmbed',
                            url:myurl
                        };
                        iframeElem.contentWindow.postMessage(obj,iframeElem.src);
                        if(iframeModalObject == null)
                            newModalIframe();
                        var p = document.querySelectorAll('p:empty');
                        for(var i = p.length - 1; i > -1; i-- ) {
                            p[i].parentNode.removeChild(p[i]);
                        }
                    };
                }
            }

        }
    };
}(window, undefined);
Application.init();